name: 'Release tag'
description: 'Create tag by the branch'
inputs:
  sourcebranch:
    description: 'Repository name with owner. For example, actions/checkout'
    required: true

runs:
  using: "composite"
  steps: 
    - uses: actions/checkout@v4
        - if: startsWith(inputs.sourcebranch, 'release/')
          name: Find Release Version From Branch
          id: release_tag_in_branch
          run: | 
            currentBranch="${{ inputs.sourcebranch }}"
            echo "Branch Name - ${currentBranch}"
            extractedVersion=${currentBranch/'release/'}
            echo "Extracted Version - ${extractedVersion}"
            echo "TAG_NAME=$extractedVersion" >> $GITHUB_OUTPUT

        - if: ${{ !steps.release_tag_in_branch.outputs.TAG_NAME }}
          name: Find Release version By Branch
          id: release_type
          run: |
             currentBranch="${{ inputs.sourcebranch }}" 
             if [[ $currentBranch == 'release' ]]; then 
              echo "Identifyed as minor release"
              echo "RELEASE_TYPE=minor" >> $GITHUB_OUTPUT
             elif [[ $currentBranch == hotfix/* ]]; then 
              echo "Identifyed as patch release"
              echo "RELEASE_TYPE=patch" >> $GITHUB_OUTPUT
             else 
              exit 0;
             fi

        - if: ${{ steps.release_type.outputs.RELEASE_TYPE }}
          name: Initiating Next Version Lookup
          id: next_release_tag_lookup
          uses: reecetech/version-increment@2023.10.1
          with:
              use_api: true
              increment: ${{ steps.release_type.outputs.RELEASE_TYPE }}
              
        - name: Next Release Version
          id: next_version
          run: echo "TAG_NAME=${{ steps.next_release_tag_lookup.outputs.version }}" >> $GITHUB_OUTPUT

        - name: Print Tag
          run: | 
            echo "Release Tag - ${{ steps.release_tag_in_branch.outputs.TAG_NAME }}"
            echo "Next Release - ${{ steps.next_version.outputs.TAG_NAME }}"

        - if: ${{ steps.release_tag_in_branch.outputs.TAG_NAME || steps.next_version.outputs.TAG_NAME }}
          name: Create Tag
          env:
            RELEASE_TAG_IN_BRANCH: ${{ steps.release_tag_in_branch.outputs.TAG_NAME }}
            NEXT_TAG: ${{  steps.next_version.outputs.TAG_NAME }}
          run: |
            RELEASING_TAG=$([ $RELEASE_TAG_IN_BRANCH ] && echo "$RELEASE_TAG_IN_BRANCH" || echo "$NEXT_TAG")
            echo "Next Tag - $RELEASING_TAG"
            git config --global user.name "GitHub Actions"
            git tag -a $RELEASING_TAG -m "Release $RELEASING_TAG"
            git push origin $RELEASING_TAG
          shell: bash


